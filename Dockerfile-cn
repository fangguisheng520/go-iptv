FROM swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/golang:1.22-alpine AS builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go env -w GO111MODULE=on &&  \
go env -w  GOPROXY=https://goproxy.cn,direct && \
go mod tidy

COPY . .

RUN go build -o iptv .


FROM swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/alpine:latest
WORKDIR /app

COPY --from=builder /app/iptv .

RUN sed -i 's#https\?://dl-cdn.alpinelinux.org/alpine#https://mirrors.tuna.tsinghua.edu.cn/alpine#g' /etc/apk/repositories; \
apk add --no-cache openjdk8-jre;\
chmod +x ./iptv

CMD ["./iptv","-port=8080","-conf=/config","-build=/build","-java=/opt/java/openjdk/bin"]