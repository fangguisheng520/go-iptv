function updateYear(){$("#year").text((new Date).getFullYear())}function replaceContent(e){e=$("<div>").html(e).find("main");e.length&&$("main").replaceWith(e),updateYear()}function getPath(t){try{return new URL(t,window.location.origin).pathname}catch(e){return t.split(/[?#]/)[0]}}function updateMenuActive(e){e=getPath(e),$(".nav-drawer a").removeClass("active"),$(".nav-drawer a").closest("li").removeClass("active"),$(".nav-item-has-subnav").removeClass("open"),$(".nav-drawer .nav-item").removeClass("active");e=$('.nav-drawer a[href="'+e+'"]');e.parent("li").addClass("active"),e.closest(".nav-item-has-subnav").addClass("open"),e.closest(".nav-item").addClass("active"),$(".selectpicker").selectpicker("refresh")}function loadPage(t,n=!0){t&&"javascript:;"!==t&&"javascript:void(0)"!==t&&$.ajax({url:t,method:"GET",success:function(e){if(("string"==typeof e?e:JSON.stringify(e)).includes("/admin/login"))window.location.href="/admin/login";else{if(replaceContent(e),"#bottom"===t.hash){const a=document.querySelectorAll("img");let t=0;(0===a.length||(a.forEach(e=>{e.complete?t++:(e.addEventListener("load",()=>{++t===a.length&&window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}),e.addEventListener("error",()=>{++t===a.length&&window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}))}),t===a.length))&&window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}n&&history.pushState(null,"",t),updateMenuActive(t)}},error:function(e){return console.error("请求失败:",e),!1}})}function submitFormPOST(t){var e=t.closest("form");if(e){lightyear.loading("show");var a=e.action||window.location.pathname;const n=new URLSearchParams;new FormData(e).forEach((e,t)=>{"iconfile"!==t&&"bjfile"!==t&&"paylistfile"!==t&&n.append(t,e)}),n.append(t.name,""),fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()}).then(async e=>{e=await e.text();if(e.includes("/admin/login"))throw window.location.href="/admin/login",e;return JSON.parse(e)}).then(e=>{lightyear.loading("hide"),lightyear.notify(e.msg,e.type,3e3),"success"===e.type&&($(t).closest(".modal").modal("hide"),loadPage(window.location.href))}).catch(e=>{lightyear.notify("提交失败","danger",3e3)})}else lightyear.notify("表单提交失败","danger",3e3)}function submitFormGET(e){var t=e.closest("form");if(t){var a=t.action||window.location.pathname;const n=new URLSearchParams;new FormData(t).forEach((e,t)=>{n.append(t,e)}),e.name&&n.append(e.name,""),loadPage(a+(a.includes("?")?"&":"?")+n.toString())}else lightyear.notify("表单提交失败","danger",3e3)}updateYear(),$(".nav-drawer .nav-item > a, .nav-drawer .nav-subnav a").click(function(e){e.preventDefault(),loadPage($(this).attr("href"))});var path=window.location.pathname;function submitFormCounts(){document.getElementById("recCounts");var e=new URL(window.location.href),t=document.querySelector("input[name='keywords']")?.value||"",t=(t&&e.searchParams.set("keywords",t),document.querySelector("select[name='recCounts']"));t&&t.value&&e.searchParams.set("recCounts",t.value),loadPage(e)}function checkboxall(e){for(var t=document.getElementsByName("ids[]"),a=0;a<t.length;a++)e.checked?t[a].checked=!0:t[a].checked=!1}function checkboxAllName(e){for(var t=document.getElementsByName("names[]"),a=0;a<t.length;a++)e.checked?t[a].checked=!0:t[a].checked=!1}function clearCheck(){for(var e=document.getElementsByName("names[]"),t=0;t<e.length;t++)e[t].checked=!1}function tdBtnPOST(a){var n=window.location.href,e=new URLSearchParams;$(a).is(":checkbox")?e.append(a.name,a.checked?1:0):e.append(a.name,a.value),lightyear.loading("show"),fetch(n,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()}).then(async e=>{e=await e.text();if(e.includes("/admin/login"))throw window.location.href="/admin/login",e;return JSON.parse(e)}).then(e=>{var t;lightyear.loading("hide"),"success"===e.type?(lightyear.notify(e.msg,e.type,1e3),a.name.includes("del")&&!a.name.includes("dellist")?(t=a.closest("tr"))&&t.remove():a.name.includes("Status")?(t=a.closest("tr"),console.log(t),t=t.querySelector("td.status-show"),console.log(t),t=t.querySelector("font"),console.log(t),t&&t.textContent.includes("上线")?(t.textContent="下线",t.color="red",a.classList.remove("btn-warning"),a.classList.add("btn-success"),a.textContent="上线"):(t.textContent="上线",t.color="#33a996",a.classList.remove("btn-success"),a.classList.add("btn-warning"),a.textContent="下线")):($(a).closest(".modal").modal("hide"),loadPage(n))):lightyear.notify(e.msg,e.type,3e3)}).catch(e=>{lightyear.notify("提交失败"+e,"danger",3e3)})}function mealsGetCategory(e){var t,a=window.location.pathname,n=new URLSearchParams;if(e.name&&e.value)n.append(e.name,e.value);else{if(!e.name)return void lightyear.notify("表单提交失败","danger",3e3);n.append(e.name,"")}"editmeal"===e.name&&(t=(e=$(e).closest("tr")).find(".meal-id").data("value"),e=e.find(".meal-name").data("value"),$("#mealId").val(t),$("#mealName").val(e)),fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()}).then(async e=>{e=await e.text();if(e.includes("/admin/login"))throw window.location.href="/admin/login",e;return JSON.parse(e)}).then(e=>{var t;"success"===e.type?e.data&&0<e.data.length?(t="",e.data.forEach(function(e){t=(t=(t+='<label class="lyear-checkbox checkbox-inline">')+'<input type="checkbox" name="ids[]" value="'+e.id+'"'+(e.checked?' checked="checked"':"")+">")+"<span>"+e.name+"</span></label>"}),$(".form-inline.meal-checkbox").html(t)):$(".form-inline.meal-checkbox").html("<span>无数据</span>"):lightyear.notify(e.msg,e.type,3e3)})}function epgEdit(e){var t,e=$(e).closest("tr"),a=e.find(".epg-id").data("value"),n=e.find(".epg-name").data("value"),e=e.find(".epg-remarks").data("value"),o=n.indexOf("-"),o=-1!==o?(t=n.substring(0,o),n.substring(o+1)):(t=n,"");$("#editepgselect").val(t),$("#epgId").val(a),$("#epgName").val(o),$("#epgRemarks").val(e)}function epgsGetChannel(e){var t=window.location.pathname,a=new URLSearchParams;if(e.name&&e.value)a.append(e.name,e.value);else{if(!e.name)return void lightyear.notify("表单提交失败","danger",3e3);a.append(e.name,"")}var n,e=$(e).closest("tr"),o=e.find(".epg-id").data("value"),e=e.find(".epg-name").data("value"),i=e.indexOf("-"),i=-1!==i?(n=e.substring(0,i),e.substring(i+1)):(n=e,"");$("#bdingepgselect").val(n),$("#epgId1").val(o),$("#epgName1").val(i),fetch(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a.toString()}).then(async e=>{e=await e.text();if(e.includes("/admin/login"))throw window.location.href="/admin/login",e;return JSON.parse(e)}).then(e=>{var t;lightyear.notify(e.msg,e.type,1e3),"success"===e.type?e.data&&0<e.data.length?(t="",e.data.forEach(function(e){t=(t=(t=(t+='<label class="lyear-checkbox checkbox-inline">')+'<div style=" float: left;background: '+(e.checked?"#7fff00;":"#E7E7E7;")+' margin-right: 3px; margin-bottom: 3px; padding: 2px 5px;">')+'<input type="checkbox" name="names[]" value="'+e.name+'"'+(e.checked?' checked="checked"':"")+">")+"<span>"+e.name+"</span></div></label>"}),$(".form-inline.epg-checkbox").html(t)):$(".form-inline.epg-checkbox").html("<span>无数据</span>"):lightyear.notify(e.msg,e.type,3e3)})}function uploadIcon(e){var t;e.target.files[0]&&(e=new FormData,(t=document.querySelector('input[name="iconfile"]'))&&0<t.files.length?(e.append("iconfile",t.files[0]),$.ajax({url:"/admin/client/uploadIcon",type:"POST",data:e,contentType:!1,processData:!1,success:function(e){$("#iconInput").val(""),lightyear.notify(e.msg,e.type,1e3),1===e.code&&($("#iconImg").attr("src",e.data.url),$("#iconContainer").show())},error:function(e){lightyear.notify(e.msg,e.type,3e3),$("#iconContainer").hide(),$("#iconInput").val("")}})):lightyear.notify("❌ 请选择文件！","danger",1e3))}function deleteIcon(){var e;""===(src=$("#iconImg").attr("src")).trim()?($("#iconContainer").hide(),$("#iconInput").val("")):((e=new URLSearchParams).append("deleteIcon",""),$.ajax({url:"/admin/client",type:"POST",data:e.toString(),contentType:"application/x-www-form-urlencoded",success:function(e){lightyear.notify(e.msg,e.type,1e3),$("#iconContainer").hide(),$("#iconImg").attr("src",""),$("#iconInput").val("")},error:function(e){lightyear.notify(e.msg,e.type,3e3)}}))}function uploadBj(e){var t;e.target.files[0]&&(e=new FormData,(t=document.querySelector('input[name="bjfile"]'))&&0<t.files.length?(e.append("bjfile",t.files[0]),$.ajax({url:"/admin/client/uploadBj",type:"POST",data:e,contentType:!1,processData:!1,success:function(e){$("#bjInput").val(""),lightyear.notify(e.msg,e.type,1e3),1===e.code&&(e=`<div class="form-group" id="bj_${e=e.data.name}" style="position:relative; margin-right:5px;"img id="${e}" src="/images/${e}.png" alt="预览" style="height:38px; border:1px solid #ccc; border-radius:4px; cursor:pointer;"span class="delete-btn" onclick="deleteBj('${e}')" data-name="${e}" id="${e}_del" style="position:absolute; top:-8px; right:-8px; background:#f00; color:#fff; border-radius:50%; font-size:14px; line-height:16px; width:16px;  height:16px; text-align:center; cursor:pointer;">×</span/div>`,$(".reload-bj").append(e))},error:function(e){$("#bjInput").val(""),lightyear.notify("❌ 上传失败！","danger",3e3),console.error("Upload error:",e)}})):lightyear.notify("❌ 请选择文件！","danger",1e3))}function deleteBj(t){var e=new URLSearchParams;e.append("deleteBj",t),$.ajax({url:"/admin/client",type:"POST",data:e.toString(),contentType:"application/x-www-form-urlencoded",success:function(e){lightyear.notify(e.msg,e.type,1e3),1===e.code&&($("#bj_"+t).remove(),$("#bjInput").val(""))},error:function(e){lightyear.notify(e.msg,e.type,3e3),$("#bjInput").val("")}})}function moviesGet(e){var t,a;"editmovie"===e.name&&(t=(e=$(e).closest("tr")).find(".movie-id").data("value"),a=e.find(".movie-name").data("value"),e=e.find(".movie-api").data("value"),$("#movieId").val(t),$("#movieName").val(a),$("#mealApi").val(e))}function confirmAndSubmit(e,t){$.confirm({title:"操作确认",content:t,type:"green",buttons:{confirm:{text:"确认",btnClass:"btn-success",action:function(){submitFormPOST(e)}},cancel:{text:"取消",btnClass:"btn-danger"}}})}function getCategoryList(e){var e=$(e).closest("tr"),t=e.find(".cl-id").data("value"),a=e.find(".cl-name").data("value"),n=e.find(".cl-url").data("value"),o=e.find(".cl-ua").data("value"),i=e.find(".cl-a").data("value"),e=e.find(".cl-r").data("value");$("#clId").val(t),$("#listname").val(a),$("#listurl").val(n),$("#listua").val(o),$("#autocategory").prop("checked",1===i),$("#repeat").prop("checked",1===e)}function getCategory(e){var e=$(e).closest("tr"),t=e.find(".ca-id").data("value"),a=e.find(".ca-name").data("value"),n=e.find(".ca-type").data("value"),o=e.find(".ca-ua").data("value"),i=e.find(".ca-rules").data("value"),e=e.find(".ca-proxy").data("value");$("#caId").val(t),$("#caname").val(a),$("#caua").val(o),$("#rules").val(i),document.getElementById("rules").disabled="auto"!==n,$("#autoagg").prop("checked","auto"===n),$("#proxy").prop("checked",1===e)}function getChannels(e){$("#showcaId").val(e),$.ajax({url:"/admin/channels",type:"POST",data:{caId:e,getchannels:""},success:function(e){if(lightyear.notify(e.msg,e.type,3e3),"success"===e.type){const n=document.getElementById("channellist_tbody");n.innerHTML="",e.data.forEach(e=>{var t=document.createElement("tr"),a=(t.align="center",20<e.url.length?e.url.substring(0,10)+"..."+e.url.slice(-10):e.url);t.innerHTML='<td style="display:none;" class="ch-id" data-value="'+e.id+'">'+e.id+'</td><td style="display:none;" class="ch-eid" data-value="'+e.e_id+'">'+e.e_id+'</td><td class="ch-name" data-value="'+e.name+'">'+e.name+'</td><td class="ch-url" data-value="'+e.url+'"><a href="'+e.url+'" target="_blank">'+a+'</a></td><td class="status-show">'+(1===e.status?'<font color="#33a996">上线</font>':'<font color="red">下线</font>')+"</td><td>"+(e.epg_name||"未绑定")+"</td><td>"+(""===e.logo?"无":'<div id="logo_'+e.id+'" style="position:relative;"><img class="ch-logo" src="'+e.logo+'" alt="预览" style="background-color:black;height:38px;border:1px solid #ccc;border-radius:4px;cursor:pointer;"></div>')+'</td><td><button type="button" onclick="tdBtnPOST(this)" name="channelsStatus" value="'+e.id+'" class="btn btn-xs '+(1===e.status?'btn-warning">下线':'btn-success">上线')+'</button>&nbsp;<button class="btn btn-xs btn-info" type="button" value="'+e.id+'" data-toggle="modal" onclick="editChannel(this)" data-target="#editchannel">编辑</button>&nbsp;<button class="btn btn-xs btn-danger" type="button" onclick="tdBtnPOST(this)" name="dellist" value="'+e.id+'">删除</button></td>',n.appendChild(t),$(".selectpicker").selectpicker("refresh")})}},error:function(){lightyear.notify("请求失败","danger",3e3)}})}function getChannels_pindao(e){$("#showcaId").val(e),$.ajax({url:"/admin/fenlei",type:"POST",data:{caId:e,getchannels_pindao:""},success:function(e){if(lightyear.notify(e.msg,e.type,3e3),"success"===e.type){const a=document.getElementById("channellist_tbody_pindao");a.innerHTML="",console.log("普通日志",e),e.data.forEach(e=>{var t=document.createElement("tr");t.align="center",20<e.url.length?(e.url.substring(0,10),e.url.slice(-10)):e.url;t.innerHTML='<td style="display:none;" class="ch-id" data-value="'+e.id+'">'+e.id+'</td><td class="ch-name" data-value="'+e.name+'">'+e.name+'</td><td class="status-show">'+(1===e.status?'<font color="#33a996">上线</font>':'<font color="red">下线</font>')+"</td><td>"+(""===e.logo?"无":'<div id="logo_'+e.id+'" style="position:relative;"><img class="ch-logo" src="'+e.logo+'" alt="预览" style="background-color:black;height:38px;border:1px solid #ccc;border-radius:4px;cursor:pointer;"></div>')+'</td><td><button type="button" onclick="tdBtnPOST(this)" name="channelsStatus" value="'+e.id+'" class="btn btn-xs '+(1===e.status?'btn-warning">下线':'btn-success">上线')+'</button>&nbsp;<button class="btn btn-xs btn-info" type="button" value="'+e.id+'" data-toggle="modal" onclick="editChannel_pindao(this)" data-target="#editChannel_pindao">修改</button>&nbsp;<button class="btn btn-xs btn-danger" type="button" onclick="tdBtnPOST(this)" name="dellist" value="'+e.id+'">删除</button></td>',$(t).data("rss-rules",e.rss_rules),$(t).data("epg-rules",e.epg_rules),$(t).data("rss-list",e.rss_list),$(t).data("epg-list",e.epg_list),a.appendChild(t),$(".selectpicker").selectpicker("refresh")})}},error:function(){lightyear.notify("请求失败","danger",3e3)}})}function getChannelsTxt(e){var e=$(e).closest("tr"),t=e.find(".ca-id").data("value"),e=e.find(".ca-name").data("value");$("#showtxtcaId").val(t),$("#showtxtCaname").val(e),$.ajax({url:"/admin/channels",type:"POST",data:{caId:t,getchannels:""},success:function(e){var t;lightyear.notify(e.msg,e.type,3e3),"success"===e.type&&(document.getElementById("channellist_tbody"),t="",e.data.forEach(e=>{t+=e.status+"|"+e.name+","+e.url+"\n"}),$("#srclist").val(t))},error:function(){lightyear.notify("请求失败","danger",3e3)}})}function editChannel(e){var t=$(e).closest("tr"),a=t.find(".ch-id").data("value"),n=t.find(".ch-name").data("value"),o=t.find(".ch-url").data("value"),t=t.find(".ch-eid").data("value"),i=$(e).closest("tr").find("td div img.ch-logo").attr("src")||"",e=e.closest("form");if(e){const l=new URLSearchParams;new FormData(e).forEach((e,t)=>{l.append(t,e)}),$("#editcaId").val(l.get("caId")),$("#chId").val(a),$("#chname").val(n),$("#chURL").val(o),$("#e_id").val(t),$("#e_id").selectpicker("refresh"),i?$("#logoContainerEdit").show().find("img").attr("src",i):$("#logoContainerEdit").hide()}else lightyear.notify("表单提交失败","danger",3e3)}function editChannel_pindao(e){var t=$(e).closest("tr"),a=t.find(".ch-id").data("value"),n=t.find(".ch-name").data("value"),o=t.data("rss-rules"),i=t.data("epg-rules"),l=t.data("rss-list"),r=t.data("epg-list"),t=t.find(".ch-url").data("value"),s=$(e).closest("tr").find("td div img.ch-logo").attr("src")||"",e=e.closest("form");if(e){const c=new URLSearchParams;new FormData(e).forEach((e,t)=>{console.log(t,e),c.append(t,e)}),console.log("editChannel_pindao"),$("#editcaId").val(c.get("caId")),$("#chId").val(a),$("#chname").val(n),$("#chURL").val(t),$("#rss_rules").val(o),$("#epg_rules").val(i),l&&(e=l.split(","),$("#rss_list_id").val(e)),r&&(a=r.split(","),$("#epg_list_id").val(a)),$("#rss_list_id").selectpicker("refresh"),$("#epg_list_id").selectpicker("refresh"),$("#rss_list_id, #epg_list_id").on("changed.bs.select",function(e,t,a,n){var o,i=$(this),l=i.val()||[],r=$(i.find("option")[t]).val();"-1"===r||"0"===r?(o=l.filter(e=>e===r),i.val(o)):"-1"!==r&&"0"!==r&&(o=l.filter(e=>"-1"!==e&&"0"!==e),i.val(o)),i.selectpicker("refresh")}),s?$("#logoContainerEdit").show().find("img").attr("src",s):$("#logoContainerEdit").hide()}else lightyear.notify("表单提交失败","danger",3e3)}function saveChannelsOne(e){var t=e.closest("form");if(t){const n=new URLSearchParams;new FormData(t).forEach((e,t)=>{"logofile"!==t&&n.append(t,e)}),n.append("saveChannelsOne","");var a=$(e).closest(".modal");$.ajax({url:"/admin/channels",type:"POST",data:n.toString(),success:function(e){lightyear.notify(e.msg,e.type,3e3),"success"===e.type&&(a.modal("hide"),getChannels(n.get("caId")))},error:function(){lightyear.notify("请求失败","danger",3e3)}})}else lightyear.notify("表单提交失败","danger",3e3)}function saveChannelsOne_fenlei(e){var t=e.closest("form");if(t){const n=new URLSearchParams;new FormData(t).forEach((e,t)=>{"logofile"!==t&&n.append(t,e)});var t=$("#rss_list_id").val(),t=(t&&0!==t.length||n.set("rss_list_id[]","0"),$("#epg_list_id").val()),a=(t&&0!==t.length||n.set("epg_list_id[]","0"),n.append("saveChannelsOne_fenlei",""),$(e).closest(".modal"));console.log("params",n),$.ajax({url:"/admin/fenlei",type:"POST",data:n.toString(),success:function(e){lightyear.notify(e.msg,e.type,3e3),"success"===e.type&&(a.modal("hide"),getChannels_pindao(n.get("caId")))},error:function(){lightyear.notify("请求失败","danger",3e3)}})}else lightyear.notify("表单提交失败","danger",3e3)}function getLogo(){var e=$("#e_id").find("option:selected").data("value")||"";e?$("#logoContainerEdit").show().find("img").attr("src",e):$("#logoContainerEdit").hide().find("img").attr("src","")}function rssPOST(e){var a=$(e).closest("tr").find(".meal-id").data("value"),e=new URLSearchParams;e.append("id",a),fetch("/admin/getRssUrl",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()}).then(async e=>{e=await e.text();if(e.includes("/admin/login"))throw window.location.href="/admin/login",e;return JSON.parse(e)}).then(e=>{"success"===e.type?(lightyear.notify(e.msg,e.type,1e3),e.data.forEach(function(e,t){"txt"===e.type?($("#getnewkey").val(a),$("#rsstxt").val(e.url)):"m3u8"===e.type?$("#rssm3u").val(e.url):"epg"===e.type&&$("#rssepg").val(e.url)})):lightyear.notify(e.msg,e.type,3e3)})}function CopyRss(e){e.select(),document.execCommand("copy"),lightyear.notify("✅ 已复制到剪贴板！","success",1e3)}function uploadPayList(e){var t,a=window.location.pathname;e.target.files[0]&&(e=new FormData,(t=document.querySelector('input[name="paylistfile"]'))&&0<t.files.length?(e.append("paylistfile",t.files[0]),$.ajax({url:"/admin/channels/uploadPayList",type:"POST",data:e,contentType:!1,processData:!1,success:function(e){$("#paylistfile").val(""),lightyear.notify(e.msg,e.type,1e3),loadPage(a)},error:function(e){lightyear.notify(e.msg,e.type,3e3),$("#paylistfile").val("")}})):lightyear.notify("❌ 请选择文件！","danger",1e3))}function uploadEpg(e){e=e.target.files[0];e?$("#epgfilename").text(e.name):$("#epgfilename").text("")}function uploadLogo(e){var t,a;e.files&&0!==e.files.length&&(t=e.files[0],e=$(e).closest("tr").data("name"),(a=new FormData).append("uploadlogo",t),a.append("epgname",e),$.ajax({url:"/admin/channels/uploadLogo",type:"POST",data:a,processData:!1,contentType:!1,success:function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return console.error("解析 JSON 失败:",e),void lightyear.notify("上传失败","danger",3e3)}e&&"string"==typeof e.msg&&e.msg.includes("/admin/login")?window.location.href="/admin/login":e&&"success"===e.type?(lightyear.notify(e.msg,e.type,3e3),document.querySelectorAll('input[type="file"]').forEach(e=>e.value=""),loadPage(window.location.href)):e&&e.msg&&(lightyear.notify(e.msg,e.type||"danger",3e3),document.querySelectorAll('input[type="file"]').forEach(e=>e.value=""))},error:function(e){console.error(e),lightyear.notify("上传失败","danger",3e3)}}))}function getEpgList(e){var e=$(e).closest("tr"),t=e.find(".e-id").data("value"),a=e.find(".e-name").data("value"),n=e.find(".e-url").data("value"),e=e.find(".e-ua").data("value");$("#eid").val(t),$("#epgfromname").val(a),$("#epgfromurl").val(n),$("#epgfromua").val(e)}function deleteLogo(t){var e=new URLSearchParams;e.append("deleteLogo",t),$.ajax({url:"/admin/epgsList",type:"POST",data:e.toString(),contentType:"application/x-www-form-urlencoded",success:function(e){lightyear.notify(e.msg,e.type,1e3),1===e.code&&($("#logo_"+t).remove(),$("#uploadlogo").val(""))},error:function(e){lightyear.notify(e.msg,e.type,3e3),$("#uploadlogo").val("")}})}function getnewkey(t){$.confirm({title:"操作确认",content:"刷新KEY后之前的链接将不可用，确认刷新吗？",type:"green",buttons:{confirm:{text:"确认",btnClass:"btn-success",action:function(){var e=new URLSearchParams;e.append("getnewkey",t.value),$.ajax({url:"/admin/getRssUrl",type:"POST",data:e.toString(),contentType:"application/x-www-form-urlencoded",success:function(e){lightyear.notify(e.msg,e.type,1e3),"success"===e.type?(lightyear.notify(e.msg,e.type,1e3),e.data.forEach(function(e,t){"txt"===e.type?$("#rsstxt").val(e.url):"m3u8"===e.type?$("#rssm3u").val(e.url):"epg"===e.type&&$("#rssepg").val(e.url)})):lightyear.notify(e.msg,e.type,3e3)},error:function(e){lightyear.notify(e.msg,e.type,3e3)}})}},cancel:{text:"取消",btnClass:"btn-danger"}}})}function BuildApk(e){var t=e.closest("form");if(t){var a=t.action||window.location.pathname;const n=new URLSearchParams;new FormData(t).forEach((e,t)=>{n.append(t,e)}),n.append(e.name,""),n.has("up_sets")||n.append("up_sets",0),fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()}).then(async e=>{e=await e.text();if(e.includes("/admin/login"))throw window.location.href="/admin/login",e;return JSON.parse(e)}).then(e=>{lightyear.notify(e.msg,e.type,3e3),"success"===e.type&&($("#submitappinfo").prop("disabled",!0),$(".download-link").prop("disabled",!0),getBuildStatus())}).catch(e=>{lightyear.notify("提交失败:"+e,"danger",3e3)})}else lightyear.notify("表单提交失败","danger",3e3)}function getBuildStatus(){var t=setInterval(function(){$.getJSON("/admin/client/buildStatus",function(e){$("#apksize").val(e.data.size),1===e.code&&(lightyear.notify(e.msg,e.type,1e3),$(".download-link").each(function(){$(this).attr("href",e.data.url),$(this).attr("download",e.data.name)}),$("#app_version").val(e.data.version),$("#submitappinfo").prop("disabled",!1),$(".download-link").prop("disabled",!1),clearInterval(t))}).fail(function(){lightyear.notify("请求失败，稍后重试...","danger",1e3)})},1e3)}function toggleLock(e){const t=document.getElementById("serverUrl"),a=e.querySelector("i");t.hasAttribute("readonly")?$.confirm({title:"操作确认",content:"修改APK连接地址后，需要重新构建APK，且之前APK可能出现网络连接失败，确认修改吗？",type:"green",buttons:{confirm:{text:"确认",btnClass:"btn-danger",action:function(){t.removeAttribute("readonly"),t.focus(),t.value=window.location.origin,a.className="mdi mdi-lock-open",e.classList.remove("btn-danger"),e.classList.add("btn-primary")}},cancel:{text:"取消",btnClass:"btn-success"}}}):(t.setAttribute("readonly",!0),a.className="mdi mdi-lock",e.classList.remove("btn-primary"),e.classList.add("btn-danger"))}function caMoveup(){const t=document.getElementById("categorylist_tbody");if(t){var e,a=t.querySelector("input[type='checkbox']:checked");if(a){const n=a.closest("tr");if(n){const o=n.previousElementSibling;o?(a=a.value,(e=new URLSearchParams).append("moveup",a),$.ajax({url:"/admin/channels",type:"POST",data:e.toString(),success:function(e){"success"===e.type?(lightyear.notify(e.msg,e.type,1e3),t.insertBefore(n,o)):lightyear.notify(e.msg,e.type,1e3)},error:function(){lightyear.notify("操作失败","danger",1e3)}})):lightyear.notify("已经是第一行了","danger",1e3)}else lightyear.notify("未找到对应行","danger",1e3)}else lightyear.notify("请先选择一个分类","danger",1e3)}}function caMoveup_fenlei(){const t=document.getElementById("categorylist_tbody");if(t){var e,a=t.querySelector("input[type='checkbox']:checked");if(a){const n=a.closest("tr");if(n){const o=n.previousElementSibling;o?(a=a.value,(e=new URLSearchParams).append("moveup",a),$.ajax({url:"/admin/fenlei",type:"POST",data:e.toString(),success:function(e){"success"===e.type?(lightyear.notify(e.msg,e.type,1e3),t.insertBefore(n,o)):lightyear.notify(e.msg,e.type,1e3)},error:function(){lightyear.notify("操作失败","danger",1e3)}})):lightyear.notify("已经是第一行了","danger",1e3)}else lightyear.notify("未找到对应行","danger",1e3)}else lightyear.notify("请先选择一个分类","danger",1e3)}}function caMovedown(){const t=document.getElementById("categorylist_tbody");if(t){var e,a=t.querySelector("input[type='checkbox']:checked");if(a){const n=a.closest("tr");if(n){const o=n.nextElementSibling;o?(a=a.value,(e=new URLSearchParams).append("movedown",a),$.ajax({url:"/admin/channels",type:"POST",data:e.toString(),success:function(e){"success"===e.type?(lightyear.notify(e.msg,e.type,1e3),t.insertBefore(n,o.nextElementSibling)):lightyear.notify(e.msg,e.type,1e3)},error:function(){lightyear.notify("操作失败","danger",1e3)}})):lightyear.notify("已经是最后一行了","danger",1e3)}else lightyear.notify("未找到对应行","danger",1e3)}else lightyear.notify("请先选择一个分类","danger",1e3)}}function caMovedown_fenlei(){const t=document.getElementById("categorylist_tbody");if(t){var e,a=t.querySelector("input[type='checkbox']:checked");if(a){const n=a.closest("tr");if(n){const o=n.nextElementSibling;o?(a=a.value,(e=new URLSearchParams).append("movedown",a),$.ajax({url:"/admin/fenlei",type:"POST",data:e.toString(),success:function(e){"success"===e.type?(lightyear.notify(e.msg,e.type,1e3),t.insertBefore(n,o.nextElementSibling)):lightyear.notify(e.msg,e.type,1e3)},error:function(){lightyear.notify("操作失败","danger",1e3)}})):lightyear.notify("已经是最后一行了","danger",1e3)}else lightyear.notify("未找到对应行","danger",1e3)}else lightyear.notify("请先选择一个分类","danger",1e3)}}function caMovetop(){const t=document.getElementById("categorylist_tbody");if(t){var e,a=t.querySelector("input[type='checkbox']:checked");if(a){const n=a.closest("tr");n?n===t.firstElementChild?lightyear.notify("已经在最顶端了","danger",1e3):(a=a.value,(e=new URLSearchParams).append("movetop",a),$.ajax({url:"/admin/channels",type:"POST",data:e.toString(),success:function(e){"success"===e.type?(lightyear.notify(e.msg,e.type,1e3),t.insertBefore(n,t.firstElementChild)):lightyear.notify(e.msg,e.type,1e3)},error:function(){lightyear.notify("操作失败","danger",1e3)}})):lightyear.notify("未找到对应行","danger",1e3)}else lightyear.notify("请先选择一个分类","danger",1e3)}}function caMovetop_fenlei(){const t=document.getElementById("categorylist_tbody");if(t){var e,a=t.querySelector("input[type='checkbox']:checked");if(a){const n=a.closest("tr");n?n===t.firstElementChild?lightyear.notify("已经在最顶端了","danger",1e3):(a=a.value,(e=new URLSearchParams).append("movetop",a),$.ajax({url:"/admin/fenlei",type:"POST",data:e.toString(),success:function(e){"success"===e.type?(lightyear.notify(e.msg,e.type,1e3),t.insertBefore(n,t.firstElementChild)):lightyear.notify(e.msg,e.type,1e3)},error:function(){lightyear.notify("操作失败","danger",1e3)}})):lightyear.notify("未找到对应行","danger",1e3)}else lightyear.notify("请先选择一个分类","danger",1e3)}}$(".nav-drawer a").each(function(){var e=$(this).attr("href");"javascript:;"!==e&&path.startsWith(e)&&updateMenuActive(e)}),window.addEventListener("popstate",function(){loadPage(location.pathname,!1)}),$("#logout").click(function(){$.get("/admin/logout",function(){location.reload()})}),document.addEventListener("click",function(e){var t=e.target.closest("a.aboutbottom");if(t){e.preventDefault();const n=new URL(t.href,window.location.origin);void loadPage(n)}else if(t=e.target.closest("a.loaduser")){var a=document.querySelector("main.lyear-layout-content");if(a&&a.contains(t)){e.preventDefault();const n=new URL(t.href,window.location.origin);a=document.querySelector("input[name='keywords']")?.value||"";a&&n.searchParams.set("keywords",a),loadPage(n)}}});